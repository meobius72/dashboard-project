<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 대시보드</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; overflow-x: hidden; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; padding: 20px; max-width: 1920px; margin: 0 auto; box-sizing: border-box; }
        .panel { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 10px; padding: 20px; flex: 1; min-width: 300px; box-sizing: border-box; }
        .panel.youtube {
            flex-basis: calc(100% - 20px);
            max-width: calc(100% - 20px);
            overflow-y: auto;
        }
        .panel.weather {
            flex-basis: calc(50% - 20px);
            max-width: calc(50% - 20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .weather-info {
            margin-top: 15px;
            font-size: 1.2em;
        }
        .weather-info p {
            margin: 5px 0;
        }
        .weather-error {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .notice-list li .date { font-size: 0.85em; color: #666; white-space: nowrap; margin-left: 10px; }
    </style>
</head>
<body>
    <!-- <header style="background-color: #007bff; color: white; padding: 15px 20px; text-align: center;">
        <h1>통합 대시보드</h1>
    </header> -->

    <div class="container">
        <div class="panel youtube">
            <h2>교육원 홍보영상</h2>
            <div class="youtube-player">
                <iframe id="youtube-player" src="https://www.youtube.com/embed/vsSxqmwnYvA?mute=1&loop=1&autoplay=1&playlist=yCp0I4KuWJo"
                        frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="youtube-controls" style="text-align: center; margin-top: 10px;">
                <button onclick="playPreviousVideo()">이전</button>
                <button onclick="playNextVideo()">다음</button>
            </div>
        </div>

        <div class="panel weather">
            <h2>하계동 날씨 정보</h2>
            <div id="weather-data" class="weather-info">
                <p>온도: <span id="current-temp">로딩 중...</span></p>
                <p>강수량: <span id="current-rain">로딩 중...</span></p>
                <p>습도: <span id="current-humi">로딩 중...</span></p>
            </div>
            <div id="weather-error" class="weather-error"></div>
        </div>

        <div class="panel">
            <h2>TS 국가자격시험 공지사항</h2>
            <div id="kotsa-notices" class="notice-list">
                <p>로딩 중...</p>
            </div>
        </div>

        <div class="panel">
            <h2>항공교육훈련포털 공지사항 (알림)</h2>
            <div id="kaa-alarm-notices" class="notice-list">
                <p>로딩 중...</p>
            </div>
        </div>

        <div class="panel">
            <h2>항공교육훈련포털 공지사항 (공지)</h2>
            <div id="kaa-numbered-notices" class="notice-list">
                <p>로딩 중...</p>
            </div>
        </div>

        <div class="controls panel">
            <h2>화면 갱신 주기 설정</h2>
            <input type="number" id="refresh-interval-input" value="300" min="60" step="60">
            <button id="set-refresh-interval-btn">설정</button>
        </div>
    </div>

    <footer style="background-color: #333; color: white; text-align: center; padding: 10px 0; position: relative; bottom: 0; width: 100%;">
        <p>&copy; 2023 통합 대시보드. 모든 권리 보유.</p>
    </footer>

    <script>
        var player;
        var currentVideoId = '{{ current_video_id }}';
        var refreshInterval = 300;
        var refreshTimer;

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: currentVideoId,
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'loop': 1,
                    'playlist': currentVideoId,
                    'mute': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
            startRefreshTimer();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                // playNextVideo();
            }
        }

        function playNextVideo() {
            fetch('/next_video')
                .then(response => response.json())
                .then(data => {
                    player.loadVideoById(data.video_id);
                    currentVideoId = data.video_id;
                })
                .catch(error => console.error('다음 동영상 로드 오류:', error));
        }

        function playPreviousVideo() {
            fetch('/prev_video')
                .then(response => response.json())
                .then(data => {
                    player.loadVideoById(data.video_id);
                    currentVideoId = data.video_id;
                })
                .catch(error => console.error('이전 동영상 로드 오류:', error));
        }

        function fetchWeatherData() {
            console.log('fetchWeatherData 함수 호출됨');
            fetch('/get_weather')
                .then(response => response.json())
                .then(data => {
                    const tempElement = document.getElementById('current-temp');
                    const rainElement = document.getElementById('current-rain');
                    const humiElement = document.getElementById('current-humi');
                    const errorElement = document.getElementById('weather-error');

                    if (data.error) {
                        tempElement.textContent = '오류';
                        rainElement.textContent = '오류';
                        humiElement.textContent = '오류';
                        errorElement.textContent = `날씨 정보 오류: ${data.error}`;
                        console.error('날씨 정보 API 오류:', data.error);
                    } else {
                        tempElement.textContent = data.temperature ? `${data.temperature}°C` : 'N/A';
                        rainElement.textContent = data.rainfall ? `${data.rainfall}mm` : 'N/A';
                        humiElement.textContent = data.humidity ? `${data.humidity}%` : 'N/A';
                        errorElement.textContent = '';
                        console.log('날씨 정보 성공적으로 로드됨:', data);
                    }
                })
                .catch(error => {
                    const errorElement = document.getElementById('weather-error');
                    errorElement.textContent = `날씨 정보 로드 중 오류 발생: ${error}`;
                    console.error('날씨 정보 fetch 오류:', error);
                });
        }

        function updateDashboardData() {
            console.log('updateDashboardData 함수 호출됨');
            // 공지사항 갱신
            fetch('/get_notices')
                .then(response => response.json())
                .then(data => {
                    if (data && !data.error) {
                        var kotsaNoticesHtml = '';
                        data.kotsa_notices.forEach(function(notice) {
                            kotsaNoticesHtml += `<li><a href="https://lic.kotsa.or.kr/tsportal/board/view.do?manage_idx=10&menu_idx=9&board_idx=${notice.link_id}" target="_blank">${notice.title}</a> <span class="date">${notice.date}</span></li>`;
                        });
                        document.getElementById('kotsa-notices').innerHTML = `<ul>${kotsaNoticesHtml}</ul>`;

                        var kaaAlarmNoticesHtml = '';
                        data.kaa_notices.alarm_notices.forEach(function(notice) {
                            kaaAlarmNoticesHtml += `<li><a href="https://www.kaa.atims.kr/pubs/notice/notice/ViewAction.do?noti_idx=${notice.link_id}" target="_blank">[알림] ${notice.title}</a> <span class="date">${notice.date}</span></li>`;
                        });
                        document.getElementById('kaa-alarm-notices').innerHTML = `<ul>${kaaAlarmNoticesHtml}</ul>`;

                        var kaaNumberedNoticesHtml = '';
                        data.kaa_notices.numbered_notices.forEach(function(notice) {
                            kaaNumberedNoticesHtml += `<li><a href="https://www.kaa.atims.kr/pubs/notice/notice/ViewAction.do?noti_idx=${notice.link_id}" target="_blank">${notice.title}</a> <span class="date">${notice.date}</span></li>`;
                        });
                        document.getElementById('kaa-numbered-notices').innerHTML = `<ul>${kaaNumberedNoticesHtml}</ul>`;

                    } else if (data && data.error) {
                        document.getElementById('kotsa-notices').innerHTML = `<ul><li>${data.error}</li></ul>`;
                        document.getElementById('kaa-alarm-notices').innerHTML = `<ul><li>${data.error}</li></ul>`;
                        document.getElementById('kaa-numbered-notices').innerHTML = `<ul><li>${data.error}</li></ul>`;
                    }
                })
                .catch(error => console.error('공지사항 갱신 오류:', error));

            fetchWeatherData();
        }

        function startRefreshTimer() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
            refreshTimer = setInterval(updateDashboardData, refreshInterval * 1000);
            console.log('대시보드 갱신 주기가 ' + refreshInterval + '초로 설정되었습니다.');
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetch('/get_refresh_interval')
                .then(response => response.json())
                .then(data => {
                    if (data && data.interval) {
                        refreshInterval = data.interval;
                        document.getElementById('refresh-interval-input').value = refreshInterval;
                        console.log('초기 갱신 주기: ' + refreshInterval + '초');
                    }
                })
                .catch(error => console.error('갱신 주기 가져오기 오류:', error));

            updateDashboardData();

            document.getElementById('set-refresh-interval-btn').addEventListener('click', function() {
                var newInterval = document.getElementById('refresh-interval-input').value;
                fetch('/set_refresh_interval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ interval: parseInt(newInterval) }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        refreshInterval = data.new_interval;
                        startRefreshTimer();
                        alert('갱신 주기가 성공적으로 설정되었습니다: ' + refreshInterval + '초');
                    } else {
                        alert('갱신 주기 설정 오류: ' + data.message);
                    }
                })
                .catch(error => console.error('갱신 주기 설정 중 오류 발생:', error));
            });
        });
    </script>
</body>
</html> 